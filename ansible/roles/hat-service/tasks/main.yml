---
# devmem2 isn't available on debian, and is trivial, so we just build it

- name: Copy devmem2 source
  copy:
    src: devmem2.c
    dest: /tmp/devmem2.c

- name: build devmem2 binary in expected location
  command: gcc -o /usr/bin/devmem2 /tmp/devmem2.c
  args:
    creates: /usr/bin/devmem2

- name: Install packages to allow building of pillow and psutil and running of OLED
# (looping deprecated in 2.11)
  apt:
#    name: "{{ item }}"
    name: ['libjpeg-turbo8', 'python3-dev', 'libfreetype6', 'libfreetype6-dev', 'libjpeg-dev']
    state: present
#  with_items:
#    - libjpeg62-turbo
#    - python3-dev
#    - libfreetype6
#    - libfreetype6-dev
#    - libjpeg-dev

- name: Make neo battery shutdown virtualenv directory
  file:
    path: "{{ hat_service_virtualenv_dir }}"
    state: directory

# MAX_CONCURRENCY=1 means Pillow doesn't attempt to compile on all
#  CPUs, which can cause out-of-memory errors on 256MB Neos
- name: Setup neo battery shutdown virtualenv (python3)
  pip:
    virtualenv: "{{ hat_service_virtualenv_dir }}"
    virtualenv_python: python3
    name: git+https://github.com/ConnectBox/NEO_BatteryLevelShutdown.git
  environment:
    MAX_CONCURRENCY: 1
    
# Install GPIO
- name: Set path to RPi.GPIO_NP_CB (NEO)
  set_fact:
    RPi_GPIO_path: "{{ hat_service_virtualenv_dir }}/lib/python3.8/site-packages/RPi.GPIO_NP_CB"
  when: connectbox_os != "raspbian"  

- name: Clone the RPi.GPIO_NP_CB repo to battery venv (NEO)
  git: 
    repo: https://github.com/ConnectBox/Rpi.GPIO_NP_CB
    dest: "{{ RPi_GPIO_path }}"
    clone: yes
    update: yes
    force: yes
  when: connectbox_os != "raspbian"  
    
# The command must include the path to the virtual environment version of python3 or the resulting
#  library will be installed in usr/local/lib/python3.8/dist-packages rather than the desired
#  location of /usr/local/connectbox/battery_tool_venv/lib/python3.8/site-packages 
- name: Run setup.py to build RPi.GPIO (NEO)
  command: "{{ hat_service_virtualenv_dir }}/bin/python3 setup.py install"
  args:
    chdir: "{{ RPi_GPIO_path }}"
  when: connectbox_os != "raspbian"  

    
#- name: Run sudo setup.py to build RPi.GPIO
#  command: 'sudo "{{ hat_service_virtualenv_dir }}"/bin/python3 setup.py install'
#  args:
#    chdir: "{{ RPi_GPIO_path }}"

-name: Install RPi.GPIO for Raspbian build
  command: "{{ hat_service_virtualenv_dir }}/bin/pip3 install RPi.GPIO==0.7.0"
  args:
    chdir: "{{ RPi_GPIO_path }}"
  when: connectbox_os == "raspbian"  


- name: Copy PA pulldown resistor systemd service definition
  template:
    src: "{{ pa_pulldown_enabler_service_name }}.j2"
    dest: "/etc/systemd/system/{{ pa_pulldown_enabler_service_name }}"
    mode: 0644
    owner: root
    group: root
  notify:
    - restart pa pulldown service

- name: Copy neo battery shutdown systemd service definition
  template:
    src: "{{ hat_service_name }}.j2"
    dest: "/etc/systemd/system/{{ hat_service_name }}"
    mode: 0644
    owner: root
    group: root
  notify:
    - restart neo battery shutdown service

# Startup has either already happened, or will happen in the handler
- name: Enable services
  systemd:
    name: "{{ item }}"
    daemon_reload: yes
    enabled: yes
  with_items:
    - "{{ pa_pulldown_enabler_service_name }}"
    - "{{ hat_service_name }}"
    
