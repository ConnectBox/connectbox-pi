---

- name: Check if NetworkManager package is installed
  command: dpkg -s network-manager
  register: nm_installed_check
  failed_when: nm_installed_check.rc > 1

- name: Check if the command is running
  command: service --status-all
  register: nm_installed_test

- name: Stop NetworkManager
  service:
    name: network-manager
    state: stopped
    enabled: no
  when: nm_installed_test.stdout.find('network-manager') > 0


- name: Remove NetworkManager
  apt:
    pkg: network-manager
    state: absent

- name: Make sure systemd-resolved is not running
  service:
    name: systemd-resolved
    state: stopped
    enabled: no

- name: Install usbmuxd for Tethering Internet Connection
  apt:
    package: usbmuxd

- name: Configure network interfaces NEO
  template:
    src: etc_network_interfaces.j2
    dest: /etc/network/interfaces
    owner: root
    group: root
    mode: 0644
  register: etc_network_interfaces

- name: Configure network interfaces.j2 base
  template:
    src: etc_network_interfaces.j2
    dest: /etc/network/interfaces.j2
    owner: root
    group: root
    mode: 0644

- name: Configure /etc/wpa_supplicant/template direcotry
  file:
     path: /etc/wpa_supplicant/templates
     state: directory  

- name: Configure wpa_supplicant.conf
  template:
    src: wpa_supplicant.conf.j2
    dest: /etc/wpa_supplicant/wpa_supplicant.conf
    owner: root
    group: root
    mode: 0644

- name: Configure wpa_supplicant/templates 
  template:
    src: wpa_supplicant.conf.j2
    dest: /etc/wpa_supplicant/templates/wpa_supplicant.conf.j2
    owner: root
    group: root
    mode: 0644

- name: Add items dhcpcd under init.d
  blockinfile:
    path: /etc/init.d/dhcpcd
    insertafter: "### END INIT INFO"
    block: |
      # This fires up the WLAN0 on Pi
      /usr/local/connectbox/bin/wlan0.pl &
  when: not aws_instance and connectbox_os != "armbian" and connectbox_os != 'ubuntu'

- name: Register the release number
  shell:
    cmd: uname -r
  register: kernel_num


- name: give the number
  debug:
     msg: "{{ kernel_num.stdout }}"

- name: Check for drivers that already exsist and we compiled for this release
  copy:
    src: "{{ kernel_num.stdout }}/"
    dest: /lib/modules/{{ kernel_num.stdout }}/kernel/drivers/net/wireless/
    owner: root
    group: root
    mode: '0644'
  register: found_drivers
  ignore_errors: true

- name: Let the user know that we found the drivers
  debug:
     msg: "We found the drivers already compiled on the system"
  when: not found_drivers.failed

- name: lets check for exsisting 8812au driver
  shell: dmesg -k | grep 8812au
  register: driver_a
  ignore_errors: true

- name: lset check for the 8812bu driver
  shell: dmesg -k | grep 88x2bu
  register: driver_b
  ignore_errors: true

- name: Insert the driver into the kernel modules 8812au
  command: insmod  /lib/modules/{{ kernel_num.stdout }}/kernel/drivers/net/wireless/8812au.ko
  when: not found_drivers.failed and driver_a.stdout == ""

- name: insert the driver into the kernel modules 88x2bu
  command: insmod  /lib/modules/{{ kernel_num.stdout }}/kernel/drivers/net/wireless/88x2bu.ko
  ignore_errors: true
  when: not found_drivers.failed and driver_b.stdout == ""

- name: finish the module dependancies
  command: depmod
  ignore_errors: true
  when: not found_drivers.failed and (driver_a.stdout == "" or driver_b.stdout == "")

# Note we have already upgraded the OS to the lattest in role bootstrap
# now we just install the current OS build tools

- name: apt install build tools
  apt:
    pkg:
    - build-essential
    - bc
    - libelf-dev
    - libssl-dev
    state: present
  when: (found_drivers.failed or driver_a.stdout == "" or driver_b.stdout == "" )

- name: apt install raspberrypi-kernel-headers
  apt:
    pkg:
    - raspberrypi-kernel-headers
    state: present
  when: connectbox_os == "raspbian" and (found_drivers.failed or driver_a.stdout == "" or driver_b.stdout == "" )

# or apt-get install linux-headers-$(uname -r)
- name: apt install linux-headers-current-sunxi
  apt:
    pkg:
    - linux-headers-current-sunxi
    state: present
  when: connectbox_os != "raspbian" and (found_drivers.failed or driver_a.stdout == "" or driver_b.stdout == "" )

- name: Copy over 8812au-install script for Raspian
  copy:
    src: 8812au-install.sh
    dest: /tmp/8812au-install.sh
    mode: "+x"
  when: found_drivers.failed or driver_a.stdout == ""

- name: Compile the 8812au driver for Raspbian or NEO
  command:
     chdir: /tmp
     cmd: "sh 8812au-install.sh"
  when: found_drivers.failed or driver_a.stdout == ""

- name: Copy over 88x2bu-install script for Raspian
  copy:
    src: 88x2bu-install.sh
    dest: /tmp/88x2bu-install.sh
    mode: "+x"
  when: found_drivers.failed or driver_b.stdout == ""

- name: Compile the 88x2bu driver for Raspbian or NEO
  command:
     chdir: /tmp
     cmd: "sh 88x2bu-install.sh"
  when: found_drivers.failed or driver_b.stdout == ""

- name: remove build tools
  apt:
    pkg:
    - build-essential
    - bc
    - libelf-dev
    - libssl-dev
    - raspbewrrypi-kernel-headers
    state: absent
  when: (found_drivers.failed or driver_a.stdout == "" or driver_b.stdout == "" )

- name: create a directgory for the fetch of the commpiled files 
  file:
    path: "/home/kernel_drivers/{{ kernel_num.stdout }}"
    state: directory
  ignore_errors: yes

#- name: if we built the drivers then lets keep a copy on the build system
#  fetch:
#    src: '/usr/lib/modules/{{ kernel_num.stdout }}/kernel/drivers/net/wireless/8812au.ko'
#    dest: '/home/kernel_drivers/{{ kernel_num }}'
#    fail_on_missing: yes
#    flat: yes
#  when: found_drivers.failed or driver_a.stdout == ""

#- name: if we built the drivers then lets keep a copy on the build system
#  fetch:
#    src: '/usr/lib/modules/{{ kernel_num.stdout }}/kernel/drivers/net/wireless/88x2bu.ko'
#    dest: '/home/kernel_drivers/{{ kernel_num }}'
#    fail_on_missing: yes
#    flat: yes
#  when: found_drivers.failed or driver_b.stdout == ""


# Note: this is not a handler because we need the network configuration in
# effect before proceeding with the wifi-ap and firewall roles, which will
# otherwise fail if not.
- name: Restart network
  service:
    name: systemd-networkd.service
    state: restarted
  when: etc_network_interfaces.changed
  tags:
    # This task on change is intentionally not a handler; don't trigger ANSIBLE0016
    - skip_ansible_lint


