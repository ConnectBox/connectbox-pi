---

- name: Check if NetworkManager package is installed
  command: dpkg -s network-manager
  register: nm_installed_check
  failed_when: nm_installed_check.rc > 1

- name: Stop NetworkManager
  service:
    name: network-manager
    state: stopped
    enabled: no
  when: nm_installed_check.rc == 0

- name: Remove NetworkManager
  apt:
    pkg: network-manager
    state: absent

- name: Make sure systemd-resolved is not running
  service:
    name: systemd-resolved
    state: stopped
    enabled: no
  when: connectbox_os != "raspian"

- name: Configure network interfaces NEO
  template:
    src: etc_network_interfaces.j2
    dest: /etc/network/interfaces
    owner: root
    group: root
    mode: 0644
  when: connectbox_os != "raspbian"
  register: etc_network_interfaces

- name: Configure network interfaces RPi
  template:
    src: etc_network_interfaces-RPi.j2
    dest: /etc/network/interfaces
    owner: root
    group: root
    mode: 0644
  when: connectbox_os == "raspbian"
  register: etc_network_interfaces

- name: apt update before kernal dowloads
  apt:
    update_cache: yes 

- name: apt upgrade before kernel downloads
  apt:
    upgrade: dist

- name: apt install build tools
  apt:
    pkg:
    - build-essential
    - bc
    - wget
    - libelf-dev
    - libssl-dev
    state: present

- name: apt install raspberrypi-kernel-headers
  apt:
    pkg:
    - raspberrypi-kernel-headers
    state: present
  when: connectbox_os == "raspbian"

# or apt-get install linux-headers-$(uname -r)
- name: apt install linux-headers-current-sunxi
  apt:
    pkg:
    - linux-headers-current-sunxi
    state: present
  when: connectbox_os != "raspbian"

# The system takes 5-10 seconds to disappear from the network
#  so let's wait 15 seconds before doing our first check
#  Use newer ansible 2.7 function reboot
- name: Reboot device for changes to take effect
  reboot:
    post_reboot_delay: 15
    pre_reboot_delay: 2
    reboot_timeout: 600

# we trust that we get the same IP address.  If not we will have to re-run the script.
# note that we loose everything in the /tmp directory on the reboot.  

- name: Copy over 8812au-install script for Raspian
  copy:
    src: 8812au-install.sh
    dest: /tmp/8812au-install.sh
    mode: "+x"

- name: Compile the 8812au & 88x2bu driver for Raspbian or NEO
  command:
     chdir: /tmp
     cmd: "sh 8812au-install.sh"

- name: remove build tools
  apt:
    pkg:
    - build-essential
    - bc
    - wget
    - libelf-dev
    - libssl-dev
    - raspbewrrypi-kernel-headers
    state: absent

# Note: this is not a handler because we need the network configuration in
# effect before proceeding with the wifi-ap and firewall roles, which will
# otherwise fail if not.
- name: Restart network
  service:
    name: systemd-networkd.service
    state: restarted
  when: etc_network_interfaces.changed
  tags:
    # This task on change is intentionally not a handler; don't trigger ANSIBLE0016
    - skip_ansible_lint


